FROM golang:1.24 AS builder

RUN apt-get update && apt-get install -y \
    make \
    git \
    protobuf-compiler \
    libprotobuf-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

COPY go.mod go.sum ./
RUN go mod download

RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@latest && \
    go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

COPY . .

RUN make build

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get clean && rm -rf /var/lib/apt/lists/* && \
    apt-get update && apt-get install -y \
    curl \
    gnupg \
    lsb-release \
    software-properties-common \
    ca-certificates \
    iproute2 \
    pciutils \
    numactl \
    libnuma1 \
    python3 \
    && rm -rf /var/lib/apt/lists/*

RUN curl -s https://deb.frrouting.org/frr/keys.gpg | tee /usr/share/keyrings/frrouting.gpg > /dev/null && \
    echo "deb [signed-by=/usr/share/keyrings/frrouting.gpg] https://deb.frrouting.org/frr $(lsb_release -s -c) frr-stable" | tee /etc/apt/sources.list.d/frr.list && \
    apt-get update && \
    apt-get install -y \
    frr \
    frr-pythontools \
    && rm -rf /var/lib/apt/lists/*

RUN curl -s https://packagecloud.io/install/repositories/fdio/release/script.deb.sh | bash && \
    apt-get update && \
    apt-get install -y \
    vpp=25.10-release \
    vpp-plugin-core=25.10-release \
    libvppinfra=25.10-release \
    vpp-dev=25.10-release \
    && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /var/log/vpp /run/vpp /etc/vpp && \
    chown -R vpp:vpp /var/log/vpp /run/vpp 2>/dev/null || true

COPY test-infra/vpp-plugins/*.so /usr/lib/x86_64-linux-gnu/vpp_plugins/

COPY --from=builder /build/bin/osvbngd /usr/local/bin/osvbngd
COPY --from=builder /build/test-infra/configs/osvbng.yaml /etc/bng/bng.yaml
COPY --from=builder /build/test-infra/configs/vpp-startup-docker.conf /etc/vpp/startup.conf
COPY --from=builder /build/test-infra/frr /etc/frr
COPY --from=builder /build/templates /usr/share/osvbng/templates
COPY --from=builder /build/test-infra/docker-entrypoint-configd.sh /docker-entrypoint.sh

RUN chmod +x /docker-entrypoint.sh && \
    chown -R frr:frr /etc/frr && \
    chmod 640 /etc/frr/*

ENV VPP_STARTUP_CONF=/etc/vpp/startup.conf

ENTRYPOINT ["/docker-entrypoint.sh"]
